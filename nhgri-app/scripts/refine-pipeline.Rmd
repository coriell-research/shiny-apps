---
title: "Modify functions in pipeline"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    theme: flatly
    highlight: tango
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

This file will be used to refine the function calls used in the `helpers.R` 
file by the shiny app. 

There are certain steps that are going to be tricky and probably can't be
worked out by modifying the app and re-running a bunch of times.

## Load Libraries and Source Helpers

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(readxl)
library(lubridate)
library(openxlsx)

source("../helpers.R")
```

## Pipeline

The below steps are just for processing the input files.

```{r}
SSRS <- "../data/test-data/NHGRI Shipping History Detail 110120_013121.xlsx"
LAY <- "../data/test-data/NHGRI_lay_summary_20210119.csv"


ssrs <- read_excel(SSRS, skip = 1) %>% janitor::clean_names()
lay <- read_csv(LAY) %>% janitor::clean_names()
report_dfs <- clean_and_split_ssrs(ssrs)
lay_unnested <- clean_and_unnest_lay(lay)
lay_dfs <- join_lay_onto_reports(report_dfs, lay_unnested)
     
# drop population column from report dfs after joins
report_dfs <- report_dfs %>%
     map(select, -Population) %>%
     map(arrange, Investigator)
     
# split the Investigator column into first last for both sets of data frames
report_dfs <- split_investigator(report_dfs)
lay_dfs <- split_investigator(lay_dfs)
```

## Create functions for checking processed output

```{r}

check_processing <- function(reports, lays) {
  check_missing <- function(df) {
    missing <- sapply(df, function(x) {
      any(is.na(x))
    })
    names(missing[missing])
  }

  reports_missings <- lapply(reports, check_missing)
  reports_missings <- reports_missings[!sapply(reports_missings, rlang::is_empty)] %>% lapply(paste, collapse = ",")
  lay_missings <- lapply(lays, check_missing)
  lay_missings <- lay_missings[!sapply(lay_missings, rlang::is_empty)] %>% lapply(paste, collapse = ",")

  messages <- c()
  if (!rlang::is_empty(reports_missings)) {
    for (p in names(reports_missings)) {
      msg <- paste("Columns:", reports_missings[[p]], "contain missing rows in", p, "Research Intent table. Check data.")
      messages <- append(messages, msg)
    }
  }

  if (!rlang::is_empty(lay_missings)) {
    for (p in names(lay_missings)) {
      msg <- paste("Columns:", lay_missings[[p]], "contain missing rows in", p, "Lay Summary table. Check data.")
      messages <- append(messages, msg)
    }
  }
  messages
}
```


